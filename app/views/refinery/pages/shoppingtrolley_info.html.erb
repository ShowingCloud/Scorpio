<form action="" method="get">
	<!--中间部分开始-->

	<div id="main">
		<div class="current_place">
			<ul>
				<li><a href="/" target="_self">首页</a>&gt;&gt;</li>
				<li><a href="#" target="_self">我的购物车</a></li>
				<div style="clear:both"></div>
			</ul>
		</div>
		<!--左侧菜单开始-->
		<div id="mem_des_before_left_total">
			<div id="mem_des_before_left">
				<div class="mem_des_before_left_head_img"> &nbsp; </div>
				<div class="mem_des_before_left_head_title">会员中心</div>
				<ul>
					<li class="mem_des_before_left_item"><a href="/%E5%9C%A8%E7%BA%BF%E8%B4%AD%E4%B9%B0/%E4%BC%9A%E5%91%98%E7%99%BB%E5%BD%952" target="_self">个人信息</a></li>
					<li class="mem_des_before_left_item"><a href="/%E5%9C%A8%E7%BA%BF%E8%B4%AD%E4%B9%B0/%E6%88%91%E7%9A%84%E7%A7%AF%E5%88%86" target="_self">我的积分</a></li>
					<li class="mem_des_before_left_item"><a href="/%E5%9C%A8%E7%BA%BF%E8%B4%AD%E4%B9%B0/%E5%85%91%E6%8D%A2%E7%A7%AF%E5%88%86" target="_self">兑换积分</a></li>
					<li class="mem_des_before_left_item"><a href="/%E5%9C%A8%E7%BA%BF%E8%B4%AD%E4%B9%B0/%E5%85%91%E6%8D%A2%E5%8E%86%E5%8F%B2" target="_self">查看兑换历史</a></li>
					<li class="mem_des_before_left_item"><a href="/%E5%9C%A8%E7%BA%BF%E8%B4%AD%E4%B9%B0/%E6%88%91%E7%9A%84%E8%AE%A2%E5%8D%95" target="_self">我的订单</a></li>
					<li class="mem_des_before_left_item_blue"><a href="#" target="_self">购物车</a></li>
					<li class="mem_des_before_left_item"><a href="/%E8%81%94%E7%B3%BB%E6%88%91%E4%BB%AC/%E5%AE%A2-%E6%9C%8D" target="_self">退货</a></li>
				</ul>        
			</div>
		</div>
		<!--右侧内容开始-->
		<div id="mem_des_before_right_total">
			<div class="trolley_product_right_top">
				<div class="trolleypic"><img src="/assets/trolley_menu2.jpg" width="713" height="40" /></div>   
				<div style="margin-left:21px">
					<div id="mem_des_before_right_item_title">
						<ul>
							<li class="mem_basic_info_text">送货信息&nbsp; </li>
							<li class="mem_basic_info_mark">*  </li>
							<li class="mem_basic_info_mark"><sub>为必填内容</sub></li>
							<div style="clear:both"></div>
						</ul>
					</div>

					<table>
						<tr>
							<td width="102">
								<div class="mem_basic_info_name_text">选择地址类别</div>
							</td>
							<td width="7" >
								<div class="">
									<select >
										<option value="recordchangeb1" size="23">公司地址</option>
										<option value="recordchangeb2" size="23">家庭地址</option>
									</select>
								</div>
							</td>
							<td>
								<div><input type="submit" class=“addaddress” value="+添加收货地址" style="border:none;text-decoration:underline;background:#fff;"></input>
								</td>                
							</tr> 
						</table>
						<table>
							<tr>
								<td> <div class="mem_basic_info_name_text">地址类别名称 </div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td> <div>：<input id="addrname" class="textblank" type="text" name="addrname" size="46"></div>
								</td>
							</tr> 
						</table>
						<table>
							<tr>
								<td width="32">
									<div class="mem_basic_info_name_text">姓名</div>
								</td>
								<td width="7" >
									<div class="mem_basic_info_mark2">*</div>
								</td>
								<td width="60" >
									<div class="maohao1">:</div>
								</td>
								<td width="293">
									<div><input id="fullname" class="textblank" type="text" name="name" size="46"></div>
								</td>
							</tr> 
						</table>
				
						<table id="city_select_province_city_area">
							<tr>
								<td> <div class="mem_basic_info_name_text">省份 </div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td width="10"> <div class="maohao1">:</div>
								</td>
								<td> <select id="DropProvince" style="width: 150px;" onchange="changeProvince(this.options[this.selectedIndex].value)"></select>
								</td>
								<td> <div class="mem_basic_info_name_text">城市 </div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td> <div>：<select id="DropCity" style="width: 150px;" onchange="changeCity(this.options[this.selectedIndex].value)"></div>
								</td>
								<td> <div class="mem_basic_info_name_text">区县 </div>
								</td>
								<td width="8"> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td> <div>：<select id="DropArea" style="width: 150px;" ></div>
								</td>
							</tr> 
						</table>  
						<table>
							<tr>
								<td> <div class="mem_basic_info_name_text">送货地址 </div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td width="40"> <div class="maohao1">:</div>
								</td>
								<td> <div><input id="contactaddr" class="textblank" type="text" name="address" size="46"></div>
								</td>
							</tr> 
						</table>
						<table>
							<tr>
								<td width="32"> <div class="mem_basic_info_name_text">邮编</div>
								</td>
								<td width="7"> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td width="62" >
									<div class="maohao1">:</div>
								</td>
								<td> <div><input id="postcode" class="textblank" type="text" name="postcode" size="46"></div>
								</td>
							</tr> 
						</table>
						<table>
							<tr>
								<td> <div class="mem_basic_info_name_text">手机号码</div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td width="40" >
									<div class="maohao1">:</div>
								</td>
								<td> <div><input id="telephone" class="textblank" type="text" name="phone" size="46"></div>
								</td>
							</tr> 
						</table>
						<table>
							<tr>
								<td> <div class="mem_basic_info_name_text">电邮地址</div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td width="40" >
									<div class="maohao1">:</div>
								</td>
								<td> <div><input id="email" class="textblank" type="text" name="mail" size="46"></div>
								</td>
							</tr> 
						</table>
						<table>
							<tr>
								<td width="65">
									<div class="mem_basic_info_name_text">送货时间</div>
								</td>
								<td >
								<td width="37" >
									<div class="maohao1">:</div>
								</td>
								<td ><div class="">
										<select  id="expect">
											<option value="recordchangeb1" size="23">对送货时间无特殊要求</option>
											<option value="recordchangeb2" size="23">只在工作日送货</option>
											<option value="recordchangeb3" size="23">只在双休日送货</option>
										</select>
									</div>
								</td>                            
							</tr> 
						</table>
<!--						<table >
							<tr>
								<td> <div class="mem_basic_info_name_text">是否开具发票 </div>
								</td>
								<td> <div class="mem_basic_info_mark2">*</div>
								</td>
								<td> <div><div class="mem_basic_info_select_text"><input type="radio" id="noinvoice" name="yesorno" checked>否&nbsp;</div></div>
								</td>
								<td> <div><div class="mem_basic_info_select_text"><input type="radio" id="needinvoice" name="yesorno">是&nbsp;</div></div>
								</td>
								<td> <div style="color:#000;">抬头：<input id="title" class="textblank" type="text" name="yesorno" size="43"></div>
								</td>
							</tr> 
						</table> -->
						<table>
							<tr>
								<td width="32">
									<div class="mem_basic_info_name_text">备注</div>
								</td>               
								<td width="74" >
									<div class="maohao1">:</div>
								</td>
								<td width="293">
									<div><input id="comment" class="textblank" type="text" name="name" size="46"></div>
								</td>
							</tr> 
						</table>
					</div>
					<% if session[:cart] %>
						<div class="trolleybody" style="margin-top:15px;">
							<table width="713" height="107" border="0">
								<tr>
									<td width="135">产品</td>
									<td width="135">单价</td>
									<td width="163">数量</td>
									<td width="80">小计</td>                 
								</tr>
							</table>
							<table id="myTableProduct" width="713" height="107" border="0">
								<% session[:cart].each do |productid, amount| %>
									<tr>
										<td  width="1"><input type="hidden" id="productid" value=<%= "#{productid}" %> /></td>
										<td  width="135"><img id="pic" width="120" height="111" /><div id="product_name"></div></td>
										<td  width="135">￥<label id="price"></label></td>
										<td  width="163"><label id="amount"><%= "#{amount}" %></label></td>
										<td  width="80">￥<label id="sum"></label></td>               
									</tr>	
								<% end %>
							</table>
						</div>
						<div class="producttotalprice">产品总价：￥<label id="producttotalprice"></label></div> 	   
						<input type="hidden" id="payment" value=<%= session[:payment] %> />
						<div class="producttotalprice">包装运费：￥<label id="fare">0</label></div> 	    
					<% end %>
					<div class="trolley_total">  
						<div class="trolley_telephonepic"><img src="../assets/trolley_telephone.jpg" width="45" height="37" /></div>
						<div class="trolley_telephonetext">
							<ul>
								<li>NEED ASSISTANCE?</li>
								<li>订购咨询热线 400-920-1398</li>
							</ul>
						</div>               
						<div class="totalprice">总价：￥<label id="totalprice">0</label></div> 
					</div>  
					<div class="continue" style="margin-bottom:20px;">
						<div class="continueshopping">
							<button type="button" class="laststop" value="" onclick="history.go(-1)" ></button>
							<button type="button" class="confirmpay" value="" onclick="createorder()" ></button>                       
						</div>                           
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
<% content_for :javascripts do %>
<script type="text/javascript">
<% if not session[:login] %>					
	$(document).ready (function() {openpopup(0, false);});
<% end %>

function getproductcart() {       
	$('#myTableProduct tr').each (function() {
		var productid = $(this).find ('#productid').val();

		$.ajax ({
			url: "/products/" + productid + ".json",
			type: "GET",
			dataType: "json",
			context: this
		}).done (function (resp) {
			if (resp != null) {
				if (resp.product_name)
					$(this).find ('#product_name').html (resp.product_name);

				if (resp.product_pic)
					$(this).find ('#pic').prop ('src', resp.product_pic);

				if (resp.price)
					$(this).find ('#price').html (parseFloat (resp.price).toFixed (2));

				productCount();

			} else {
				if (resp.description != null)
					alert (resp.description);
				else
					alert("请求失败，请再检查一遍您的输入并稍候再试");
			}
		}).fail (function() {
			alert("请求发送失败，请稍候再试");
		});
	});
}

function productCount(){
	var total = 0;
	var price;
	var amount;

	$('#myTableProduct tr').each (function() {
			price = $(this).find ('#price').html();
			amount = $(this).find ('#amount').html();
			$(this).find ('#sum').html ((price * amount).toFixed (2));
			total += price * amount;
	});

	var payment = $('#payment').val();
	var shipping = parseFloat (payment_price[payment]);

	$('#fare').html (shipping.toFixed (2));
	$('#producttotalprice').html (total.toFixed (2));
	$('#totalprice').html ((total + shipping).toFixed (2));

}

$(document).ready(function() {
	$("#DropProvince").html("<option value=0>--请选择--</option>");
	$("#DropCity").html("<option value=0>--请选择--</option>");
	$("#DropArea").html("<option value=0>--请选择--</option>");
	$.ajax ({
		url:		"/localities/1.json",
		type:		"GET",
		dataType:	"json"

	}).done (function (resp) {
		for (var i=0; i<resp.children.length ; i++){
			var t= resp.children[i].name;
			var j= resp.children[i].id;
			if(resp.children[i].sort==-1){
				continue;
			}
			$("#DropProvince").append("<option value="+j+">" + t + "</option>");			
		   }		
	}).fail (function() {
		alert ("请求发送失败，请稍候再试");
	                    });
});

function changeProvince(value){
//	document.getElementById("DropCity").options.length = 0;
	$("#DropCity").html("<option value=0>--请选择--</option>");
	if (value == 0){
		changeCity(value);
		return;
	}
	$.ajax ({
		url:		"/localities/"+value+".json",
		type:		"GET",
		dataType:	"json"

	}).done (function (resp) {
		for (var i=0; i<resp.children.length ; i++){
			var t= resp.children[i].name;
			var j= resp.children[i].id;			
			$("#DropCity").append("<option value="+j+">" + t + "</option>");			
		   }		
	}).fail (function() {
		alert ("请求发送失败，请稍候再试");
		});



}

function changeCity(value){
//	document.getElementById("DropArea").options.length = 0;
	$("#DropArea").html("<option value=0>--请选择--</option>");
	if (value == 0)
		return;
	$.ajax ({
		url:		"/localities/"+value+".json",
		type:		"GET",
		dataType:	"json"

	}).done (function (resp) {
		for (var i=0; i<resp.children.length ; i++){
			var t= resp.children[i].name;
			$("#DropArea").append("<option>" + t + "</option>");			
		   }		
	}).fail (function() {
		alert ("请求发送失败，请稍候再试");
	                    });


}

$(document).ready (getproductcart);

</script>
	
<% end %>
